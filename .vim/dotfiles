function! HandleDotfilesChange()
  silent exec '!cd ~/.dotfiles && test -z "$(git status --porcelain)"'
  if v:shell_error
    silent exec '!cd ~/.dotfiles && git add . && git commit -m "Automatic update" && git pull origin master && git push origin master'
    redraw!
  endif
endfunction

function! ShouldUpdateDotfiles()
  if empty(glob('~/.dotfiles/.update.log'))
    return 1
  end
  return system('echo $(($(date +%s)-$(cat ~/.dotfiles/.update.log)))') > 86400
endfunction

function! UpdateDotfiles()
  silent exec '!echo Fetching latest dotfiles'
  silent exec '!cd ~/.dotfiles && git pull origin master'
  exec '!vim -S ~/.dotfiles/.vim/symlinks'
  silent exec '!date +\%s > ~/.dotfiles/.update.log'
endfunction

autocmd! bufwritepost ~/.dotfiles/* call HandleDotfilesChange()
autocmd! bufwritepost ~/.vimrc call HandleDotfilesChange()
autocmd! bufwritepost ~/.vim/* call HandleDotfilesChange()

if ShouldUpdateDotfiles() && HasGitHub()
  call UpdateDotfiles()
  source ~/.vimrc
endif
